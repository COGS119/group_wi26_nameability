<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nameability</title>
  <script src="https://unpkg.com/jspsych@8.2.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3" type="text/javascript"></script>
  <script src="https://unpkg.com/@jspsych/plugin-categorize-image@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <link href="https://unpkg.com/jspsych@8.2.3/css/jspsych.css" rel="stylesheet" />
</head>

<body></body>

<script>
  // Init
  var jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: false,
  });

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p" + random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
    random_id: random_id,
  });
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  //wrap the timeline creation in a function
  //this allows us to make an asynchronous call with data pipe to get a condition number
  //which allows us to do true counterbalancing
  function createTimeline(condition_number) {

    //Global vars for progress bar
    var expt_len = 51;
    var expt_progress = 0;
    var timeline = [];


    // Preload images
    var preload = {
      type: jsPsychPreload,
      images: [
        'stimuli/experiment1a/high_A_000.png',
        'stimuli/experiment1a/high_A_001.png',
        'stimuli/experiment1a/high_A_010.png',
        'stimuli/experiment1a/high_B_101.png',
        'stimuli/experiment1a/high_B_110.png',
        'stimuli/experiment1a/high_B_111.png',
        'stimuli/experiment1a/low_A_000.png',
        'stimuli/experiment1a/low_A_001.png',
        'stimuli/experiment1a/low_A_010.png',
        'stimuli/experiment1a/low_B_101.png',
        'stimuli/experiment1a/low_B_110.png',
        'stimuli/experiment1a/low_B_111.png',
        'stimuli/experiment_check.webp'
      ],
      show_detailed_errors: true,
      max_load_time: 60000,
      on_error: function (file) { console.error("PRELOAD ERROR:", file); },
      on_success: function (file) { console.log("Loaded:", file); }
    };
    timeline.push(preload);



    // Fullscreen ON
    timeline.push({
      type: jsPsychFullscreen,
      fullscreen_mode: true
    });


    // Participant ID
    var participant_id_entry = {
      type: jsPsychSurveyText,
      questions: [
        { prompt: "Please enter your participant ID:", name: "participant_id" }
      ],
      on_finish: function (data) {
        jsPsych.data.addProperties({
          participant: data.response.participant_id
        });
      }
    };
    timeline.push(participant_id_entry);

    //condition now gets assigned here, no longer need the random sampling approach
    console.log(condition_number);
    if (condition_number == 0) { var condition_assignment = "easy"; }
    if (condition_number == 1) { var condition_assignment = "easy2"; }
    if (condition_number == 2) { var condition_assignment = "hard"; }
    if (condition_number == 3) { var condition_assignment = "hard2"; }

    //OLD CODE
    // Random condition assignment
    // var conditions = ["easy", "easy2", "hard2", "hard"];
    // var condition_assignment = jsPsych.randomization.sampleWithoutReplacement(conditions, 1)[0];
    console.log("Condition:", condition_assignment);


    jsPsych.data.addProperties({
      condition: condition_assignment
    });


    // Instructions
    var instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
     <p> Welcome to the experiment! </p>

     <p> In this experiment, you will see a series of images. </p>
     <p> Your task is to categorize each image into one of two categories (A and B) as quickly and accurately as possible. </p>
     <p> You will receive feedback after each response. If you get the category wrong, you will be asked to choose the category again</p>
   `
    };
    timeline.push(instructions);

    var comprehension_check_test = {
      type: jsPsychImageKeyboardResponse,
      stimulus: 'stimuli/experiment_check.webp',
      prompt: "<p><strong>Choose Q if you are paying attention.</strong></p>",
      choices: ['q', 'a', 'b'],
    };

    var comprehension_check_feedback = {
      type: jsPsychHtmlKeyboardResponse,
      trial_duration: 2000,
      stimulus: function () {
        console.log(jsPsych.data.get().last(1).values()[0]);
        var last_trial_response = jsPsych.data.get().last(1).values()[0].response
        if (last_trial_response == 'q') {
          return "<p>Fluffy blesses you. Good job!</p>"
        } else {
          return "<p>Fluffy is angered. Make sure to focus!</p>"
        }
      }
    }

    // Fixation
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 500
    };

    // Categorization trial
    // IMPORTANT:
    // - choices must be 'a'/'b' (keyboard returns lowercase)
    // - we display label A/B in text_answer for feedback
    var test = {
      type: jsPsychCategorizeImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: ['a', 'b'],
      key_answer: jsPsych.timelineVariable('correct_key'),
      text_answer: jsPsych.timelineVariable('correct_key'),
      trial_duration: 10000,

      prompt: "<p>Press <strong>A</strong> for Category A, <strong>B</strong> for Category B.</p>",
      correct_text: "<p class='prompt'>Correct! The Category is %ANS%.</p>",
      incorrect_text: "<p class='prompt'>Incorrect. The Category is %ANS%.</p>",

      data: {
        nameability: jsPsych.timelineVariable('nameability'),
        correct_category: jsPsych.timelineVariable('correct_label')
      }
    };

    //Loops test trial until correct
    var loop_test = {
      timeline: [fixation, test],
      loop_function: function () {
        var last_data = jsPsych.data.get().last(1).values()[0];
        if ((last_data.correct)) {
          expt_progress += 1
          jsPsych.progressBar.progress = expt_progress / expt_len
          console.log('CORRECT: DONT REPEAT');
          return false; //saying 'false' to loop
        } else {
          console.log('INCORRECT: REPEAT');
          return true; //saying 'true' to loop
        }
      }
    }

    // Difficulty might be misleading -> change to nameability: 'high' maybe
    // High (easy) procedure
    var test_procedure_high = {
      timeline: [fixation, loop_test],
      timeline_variables: [
        { stimulus: 'stimuli/experiment1a/high_A_000.png', correct_key: 'A', correct_label: 'A', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_A_000.png', correct_key: 'A', correct_label: 'A', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_A_001.png', correct_key: 'A', correct_label: 'A', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_A_010.png', correct_key: 'A', correct_label: 'A', nameability: 'high' },

        { stimulus: 'stimuli/experiment1a/high_B_101.png', correct_key: 'B', correct_label: 'B', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_B_110.png', correct_key: 'B', correct_label: 'B', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_B_111.png', correct_key: 'B', correct_label: 'B', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_B_111.png', correct_key: 'B', correct_label: 'B', nameability: 'high' },
      ],
      randomize_order: true,

    }; var test_procedure_high2 = {
      timeline: [fixation, loop_test],
      timeline_variables: [
        { stimulus: 'stimuli/experiment1a/high_A_000.png', correct_key: 'B', correct_label: 'A', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_A_000.png', correct_key: 'B', correct_label: 'A', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_A_001.png', correct_key: 'B', correct_label: 'A', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_A_010.png', correct_key: 'B', correct_label: 'A', nameability: 'high' },

        { stimulus: 'stimuli/experiment1a/high_B_101.png', correct_key: 'A', correct_label: 'B', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_B_110.png', correct_key: 'A', correct_label: 'B', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_B_111.png', correct_key: 'A', correct_label: 'B', nameability: 'high' },
        { stimulus: 'stimuli/experiment1a/high_B_111.png', correct_key: 'A', correct_label: 'B', nameability: 'high' },
      ],
      randomize_order: true,
    };

    // Low (hard) procedure 
    var test_procedure_low = {
      timeline: [fixation, loop_test],
      timeline_variables: [
        { stimulus: 'stimuli/experiment1a/low_A_000.png', correct_key: 'A', correct_label: 'A', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_A_000.png', correct_key: 'A', correct_label: 'A', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_A_001.png', correct_key: 'A', correct_label: 'A', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_A_010.png', correct_key: 'A', correct_label: 'A', nameability: 'low' },

        { stimulus: 'stimuli/experiment1a/low_B_101.png', correct_key: 'B', correct_label: 'B', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_B_110.png', correct_key: 'B', correct_label: 'B', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_B_111.png', correct_key: 'B', correct_label: 'B', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_B_111.png', correct_key: 'B', correct_label: 'B', nameability: 'low' },
      ],
      randomize_order: true,
    };

    var test_procedure_low2 = {
      timeline: [fixation, loop_test],
      timeline_variables: [
        { stimulus: 'stimuli/experiment1a/low_A_000.png', correct_key: 'B', correct_label: 'A', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_A_000.png', correct_key: 'B', correct_label: 'A', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_A_001.png', correct_key: 'B', correct_label: 'A', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_A_010.png', correct_key: 'B', correct_label: 'A', nameability: 'low' },

        { stimulus: 'stimuli/experiment1a/low_B_101.png', correct_key: 'A', correct_label: 'B', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_B_110.png', correct_key: 'A', correct_label: 'B', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_B_111.png', correct_key: 'A', correct_label: 'B', nameability: 'low' },
        { stimulus: 'stimuli/experiment1a/low_B_111.png', correct_key: 'A', correct_label: 'B', nameability: 'low' },
      ],
      randomize_order: true,
    };

    // Block end screens
    var test_block_1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p><strong>TEST BLOCK 1 FINISHED</strong></p><p>Press any key to continue.</p>'
    };
    var test_block_2 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p><strong>TEST BLOCK 2 FINISHED</strong></p><p>Press any key to continue.</p>'
    };
    var test_block_3 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p><strong>TEST BLOCK 3 FINISHED</strong></p><p>Press any key to continue.</p>'
    };
    var test_block_4 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p><strong>TEST BLOCK 4 FINISHED</strong></p><p>Press any key to continue.</p>'
    };
    var test_block_5 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p><strong>TEST BLOCK 5 FINISHED</strong></p><p>Press any key to continue.</p>'
    };
    var test_block_6 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p><strong>TEST BLOCK 6 FINISHED</strong></p><p>Press any key to continue.</p>'

    };



    // Push correct condition blocks (6 blocks total)
    if (condition_assignment === "easy") {
      timeline.push(
        test_procedure_high, comprehension_check_test, comprehension_check_feedback, test_block_1,
        test_procedure_high, comprehension_check_test, comprehension_check_feedback, test_block_2,
        test_procedure_high, comprehension_check_test, comprehension_check_feedback, test_block_3,
        test_procedure_high, comprehension_check_test, comprehension_check_feedback, test_block_4,
        test_procedure_high, comprehension_check_test, comprehension_check_feedback, test_block_5,
        test_procedure_high, comprehension_check_test, comprehension_check_feedback, test_block_6
      );
    } else if (condition_assignment === "easy2") {
      timeline.push(
        test_procedure_high2, comprehension_check_test, comprehension_check_feedback, test_block_1,
        test_procedure_high2, comprehension_check_test, comprehension_check_feedback, test_block_2,
        test_procedure_high2, comprehension_check_test, comprehension_check_feedback, test_block_3,
        test_procedure_high2, comprehension_check_test, comprehension_check_feedback, test_block_4,
        test_procedure_high2, comprehension_check_test, comprehension_check_feedback, test_block_5,
        test_procedure_high2, comprehension_check_test, comprehension_check_feedback, test_block_6
      );
    } else if (condition_assignment === "hard2") {
      timeline.push(
        test_procedure_low2, comprehension_check_test, comprehension_check_feedback, test_block_1,
        test_procedure_low2, comprehension_check_test, comprehension_check_feedback, test_block_2,
        test_procedure_low2, comprehension_check_test, comprehension_check_feedback, test_block_3,
        test_procedure_low2, comprehension_check_test, comprehension_check_feedback, test_block_4,
        test_procedure_low2, comprehension_check_test, comprehension_check_feedback, test_block_5,
        test_procedure_low2, comprehension_check_test, comprehension_check_feedback, test_block_6
      );
    } else {
      timeline.push(
        test_procedure_low, comprehension_check_test, comprehension_check_feedback, test_block_1,
        test_procedure_low, comprehension_check_test, comprehension_check_feedback, test_block_2,
        test_procedure_low, comprehension_check_test, comprehension_check_feedback, test_block_3,
        test_procedure_low, comprehension_check_test, comprehension_check_feedback, test_block_4,
        test_procedure_low, comprehension_check_test, comprehension_check_feedback, test_block_5,
        test_procedure_low, comprehension_check_test, comprehension_check_feedback, test_block_6
      );
    }

    var post_experiment_survey1 = {
      type: jsPsychSurveyText,
      questions: [
        { prompt: "Are you a native English speaker?", name: "Language", rows: 3, columns: 80 },
        { prompt: "Do you have any experience with art? If so what? ie. painting, acrylics, oil, watercolor", name: "Art_background", rows: 6, columns: 80 },
        { prompt: "Did you use any particular strategies when sorting the color wheels into categories? If so, what were they?", name: "Strategy", rows: 6, columns: 80 },
      ],
      on_load: function () {
        document.querySelectorAll(".jspsych-survey-text textarea").forEach((el) => {
          el.style.width = "1000px";
          el.style.maxWidth = "95%";
          el.style.minHeight = "140px";
          el.style.padding = "12px 14px";
          el.style.boxSizing = "border-box";
        });
      },
      on_finish: function () {
        expt_progress += 1
        jsPsych.progressBar.progress = expt_progress / expt_len
      }
    };
    timeline.push(post_experiment_survey1);

    var post_experiment_survey2 = {
      type: jsPsychSurveyText,
      questions: [
        { prompt: "Did you experience any technical issues when doing the experiment?", name: "Issues", rows: 6, columns: 80 },
        { prompt: "What do you think this experiment was about?", name: "Why_experiment", rows: 6, columns: 80 },
        { prompt: "Is there anything else you want the experimenters to know about the experiment?", name: "Extra_info", rows: 6, columns: 80 }
      ],
      on_load: function () {
        document.querySelectorAll(".jspsych-survey-text textarea").forEach((el) => {
          el.style.width = "1000px";
          el.style.maxWidth = "95%";
          el.style.minHeight = "140px";
          el.style.padding = "12px 14px";
          el.style.boxSizing = "border-box";
        });
      },
      on_finish: function () {
        expt_progress += 1
        jsPsych.progressBar.progress = expt_progress / expt_len
      }
    };
    timeline.push(post_experiment_survey2);
    //PLEASE KEEP FOR ALL FUTURE ITERATIONS
    //this portion of the code ensures that the data gets sent to be stored on OSF
    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "lslvudix34Dr",
      filename: filename,
      data_string: () => jsPsych.data.get().csv()
    };
    timeline.push(save_data);
    //PLEASE KEEP FOR ALL FUTURE ITERATIONS
    var debrief = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
      <p>Thank you for participating in this experiment!</p>
      <p>
        The goal of this experiment is to investigate how our access to language affects learning. <br>
        In this case, categorization rates between patterns of color with high (common) or low (uncommon) nameability.
      </p>
    </div>
  `,
      on_finish: function () {
        expt_progress += 1
        jsPsych.progressBar.progress = expt_progress / expt_len
      }
    };
    timeline.push(debrief);

    // Fullscreen OFF + End
    timeline.push({
      type: jsPsychFullscreen,
      fullscreen_mode: false
    });

    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p>Done! Thanks for participating.</p>"
    });

    // Run, good luck!
    jsPsych.run(timeline);
  }

  //this calls the asynchronous function that gets the condition assignment
  //and then runs the experiment
  async function createExperiment() {
    const condition = await jsPsychPipe.getCondition("lslvudix34Dr");
    //this will be a number 1-4
    createTimeline(condition);
  }
  createExperiment();
</script>

</html>